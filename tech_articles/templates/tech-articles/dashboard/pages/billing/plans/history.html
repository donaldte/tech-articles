{% extends 'tech-articles/dashboard/base.html' %}
{% load i18n static %}

{% block content %}
<div class="mb-6">
  <nav class="flex items-center gap-2 text-sm text-text-muted mb-4">
    <a href="{% url 'dashboard:home' %}" class="hover:text-primary transition-colors">{% translate "Dashboard" %}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
    </svg>
    <a href="{% url 'billing:plans_list' %}" class="hover:text-primary transition-colors">{% translate "Plans" %}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
    </svg>
    <span class="text-text-primary">{% translate "History" %}: {{ plan.name }}</span>
  </nav>
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold text-text-primary">{% translate "Plan History" %}: {{ plan.name }}</h1>
    <a href="{% url 'billing:plans_edit' plan.pk %}" class="btn-secondary">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      {% translate "Back to Plan" %}
    </a>
  </div>
</div>

<div class="dashboard-card">
  {% if history_records %}
    <div class="space-y-6">
      {% for record in history_records %}
        <div class="border border-border-dark rounded-lg p-5 hover:border-primary/30 transition-colors">
          <!-- Header -->
          <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
              <!-- Change Type Badge -->
              {% if record.change_type == "created" %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400">
                  <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path>
                  </svg>
                  {% translate "Created" %}
                </span>
              {% elif record.change_type == "updated" %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400">
                  <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                  </svg>
                  {% translate "Updated" %}
                </span>
              {% elif record.change_type == "deleted" %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-500/20 text-red-400">
                  <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                  </svg>
                  {% translate "Deleted" %}
                </span>
              {% else %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-text-muted/20 text-text-muted">
                  {{ record.change_type|title }}
                </span>
              {% endif %}
              
              <!-- Date & Time -->
              <span class="text-sm text-text-muted">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {{ record.created_at|date:"d M Y, H:i" }}
              </span>
            </div>
            
            <!-- Changed By -->
            {% if record.changed_by %}
              <div class="flex items-center gap-2 text-sm text-text-muted">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                </svg>
                <span>{{ record.changed_by.get_full_name|default:record.changed_by.username }}</span>
              </div>
            {% endif %}
          </div>
          
          <!-- Changes Description -->
          <div class="mb-4">
            <p class="text-text-primary text-sm leading-relaxed">{{ record.changes }}</p>
          </div>
          
          <!-- Snapshot Details (Collapsible) -->
          {% if record.snapshot %}
            <details class="group">
              <summary class="cursor-pointer text-sm text-primary hover:text-primary/80 transition-colors flex items-center gap-2">
                <svg class="w-4 h-4 transform transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                {% translate "View Snapshot" %}
              </summary>
              <div class="mt-3 pl-6 border-l-2 border-border-dark">
                <div class="grid grid-cols-2 gap-3 text-xs">
                  {% for key, value in record.snapshot.items %}
                    <div class="py-2 border-b border-border-dark/50">
                      <span class="text-text-muted font-medium">{{ key|title|cut:"_" }}:</span>
                      <span class="text-text-primary ml-2">
                        {% if value == True %}
                          <span class="text-green-400">✓ {% translate "Yes" %}</span>
                        {% elif value == False %}
                          <span class="text-red-400">✗ {% translate "No" %}</span>
                        {% elif value == None or value == "None" %}
                          <span class="text-text-muted italic">{% translate "Not set" %}</span>
                        {% else %}
                          {{ value }}
                        {% endif %}
                      </span>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </details>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <!-- Empty State -->
    <div class="text-center py-12">
      <svg class="w-16 h-16 mx-auto text-text-muted/30 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <h3 class="text-lg font-medium text-text-primary mb-2">{% translate "No History Yet" %}</h3>
      <p class="text-text-muted text-sm">{% translate "Changes to this plan will appear here." %}</p>
    </div>
  {% endif %}
</div>
{% endblock %}
