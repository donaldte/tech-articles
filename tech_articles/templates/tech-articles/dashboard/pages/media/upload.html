{% extends 'tech-articles/dashboard/pages/_page_base.html' %}
{% load i18n static %}

{% block page_title %}{% translate 'Upload Files' %}{% endblock %}

{% block page_content %}
<div class="max-w-4xl mx-auto">
  <!-- Drag & Drop Upload Zone -->
  <div id="dropzone" class="border-4 border-dashed border-border rounded-lg p-12 text-center hover:border-primary transition-colors cursor-pointer mb-6">
    <svg class="w-16 h-16 mx-auto text-text-tertiary mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
    </svg>
    <h3 class="text-xl font-semibold text-text-primary mb-2">
      {% translate 'Drag & Drop Files Here' %}
    </h3>
    <p class="text-text-secondary mb-4">
      {% translate 'or click to browse' %}
    </p>
    <p class="text-sm text-text-tertiary">
      {% translate 'Supported formats: Images, Videos, PDFs, Documents (Max 50MB)' %}
    </p>
    <input 
      type="file" 
      id="fileInput" 
      multiple 
      accept="image/*,video/*,application/pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx"
      class="hidden"
    >
  </div>

  <!-- Upload Progress -->
  <div id="uploadProgress" class="hidden mb-6">
    <h4 class="text-lg font-semibold text-text-primary mb-3">{% translate 'Uploading Files' %}</h4>
    <div id="progressList" class="space-y-2">
      <!-- Progress items will be added here -->
    </div>
  </div>

  <!-- Upload Form (Traditional) -->
  <div class="bg-bg-secondary rounded-lg p-6">
    <h3 class="text-lg font-semibold text-text-primary mb-4">
      {% translate 'File Details' %}
    </h3>
    
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      
      <div class="space-y-4">
        <!-- File Input -->
        <div>
          <label for="{{ form.file.id_for_label }}" class="block text-sm font-medium text-text-primary mb-2">
            {% translate 'File' %}
          </label>
          {{ form.file }}
        </div>

        <!-- Title -->
        <div>
          <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-text-primary mb-2">
            {% translate 'Title' %}
          </label>
          {{ form.title }}
        </div>

        <!-- Description -->
        <div>
          <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-text-primary mb-2">
            {% translate 'Description' %}
          </label>
          {{ form.description }}
        </div>

        <!-- Alt Text -->
        <div>
          <label for="{{ form.alt_text.id_for_label }}" class="block text-sm font-medium text-text-primary mb-2">
            {% translate 'Alt Text' %}
          </label>
          {{ form.alt_text }}
        </div>

        <!-- Folder -->
        <div>
          <label for="{{ form.folder.id_for_label }}" class="block text-sm font-medium text-text-primary mb-2">
            {% translate 'Folder' %}
          </label>
          {{ form.folder }}
        </div>

        <!-- Tags -->
        <div>
          <label for="{{ form.tags.id_for_label }}" class="block text-sm font-medium text-text-primary mb-2">
            {% translate 'Tags' %}
          </label>
          {{ form.tags }}
        </div>

        <!-- Access Level -->
        <div>
          <label for="{{ form.access_level.id_for_label }}" class="block text-sm font-medium text-text-primary mb-2">
            {% translate 'Access Level' %}
          </label>
          {{ form.access_level }}
        </div>
      </div>

      <div class="flex gap-4 mt-6">
        <button type="submit" class="btn btn-primary">
          {% translate 'Upload File' %}
        </button>
        <a href="{% url 'dashboard:media:library' %}" class="btn btn-secondary">
          {% translate 'Cancel' %}
        </a>
      </div>
    </form>
  </div>
</div>

<script>
// Translation strings
const translations = {
  uploading: '{% translate "Uploading..." %}',
  uploadComplete: '{% translate "Upload complete!" %}',
  uploadFailed: '{% translate "Upload failed" %}',
  uploadError: '{% translate "Upload error" %}'
};

document.addEventListener('DOMContentLoaded', function() {
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const uploadProgress = document.getElementById('uploadProgress');
  const progressList = document.getElementById('progressList');
  
  // Click to browse
  dropzone.addEventListener('click', function() {
    fileInput.click();
  });
  
  // File input change
  fileInput.addEventListener('change', function(e) {
    handleFiles(e.target.files);
  });
  
  // Drag and drop
  dropzone.addEventListener('dragover', function(e) {
    e.preventDefault();
    dropzone.classList.add('border-primary', 'bg-primary/5');
  });
  
  dropzone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    dropzone.classList.remove('border-primary', 'bg-primary/5');
  });
  
  dropzone.addEventListener('drop', function(e) {
    e.preventDefault();
    dropzone.classList.remove('border-primary', 'bg-primary/5');
    handleFiles(e.dataTransfer.files);
  });
  
  function handleFiles(files) {
    if (files.length === 0) return;
    
    // Show progress section
    uploadProgress.classList.remove('hidden');
    progressList.innerHTML = '';
    
    // Upload each file
    Array.from(files).forEach(file => {
      uploadFile(file);
    });
  }
  
  function uploadFile(file) {
    const formData = new FormData();
    formData.append('files[]', file);
    
    // Get folder from form if selected
    const folderSelect = document.querySelector('select[name="folder"]');
    if (folderSelect && folderSelect.value) {
      formData.append('folder_id', folderSelect.value);
    }
    
    // Create progress item
    const progressItem = document.createElement('div');
    progressItem.className = 'bg-bg-primary rounded-lg p-4';
    progressItem.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium text-text-primary">${file.name}</span>
        <span class="text-sm text-text-tertiary">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
      </div>
      <div class="w-full bg-bg-tertiary rounded-full h-2">
        <div class="progress-bar bg-primary h-2 rounded-full transition-all" style="width: 0%"></div>
      </div>
      <div class="status-text text-xs text-text-tertiary mt-2">${translations.uploading}</div>
    `;
    progressList.appendChild(progressItem);
    
    const progressBar = progressItem.querySelector('.progress-bar');
    const statusText = progressItem.querySelector('.status-text');
    
    // Upload with XMLHttpRequest to track progress
    const xhr = new XMLHttpRequest();
    
    xhr.upload.addEventListener('progress', function(e) {
      if (e.lengthComputable) {
        const percentComplete = (e.loaded / e.total) * 100;
        progressBar.style.width = percentComplete + '%';
      }
    });
    
    xhr.addEventListener('load', function() {
      if (xhr.status === 200) {
        progressBar.classList.remove('bg-primary');
        progressBar.classList.add('bg-green-500');
        statusText.textContent = translations.uploadComplete;
        statusText.classList.add('text-green-500');
        
        // Redirect after a short delay if all uploads are done
        setTimeout(function() {
          const allDone = Array.from(progressList.querySelectorAll('.progress-bar')).every(bar => 
            bar.classList.contains('bg-green-500') || bar.classList.contains('bg-red-500')
          );
          if (allDone) {
            window.location.href = '{% url "dashboard:media:library" %}';
          }
        }, 1000);
      } else {
        progressBar.classList.remove('bg-primary');
        progressBar.classList.add('bg-red-500');
        statusText.textContent = translations.uploadFailed;
        statusText.classList.add('text-red-500');
      }
    });
    
    xhr.addEventListener('error', function() {
      progressBar.classList.remove('bg-primary');
      progressBar.classList.add('bg-red-500');
      statusText.textContent = translations.uploadError;
      statusText.classList.add('text-red-500');
    });
    
    xhr.open('POST', '{% url "dashboard:media:api_bulk_upload" %}');
    xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
    xhr.send(formData);
  }
});
</script>
{% endblock %}
