{% extends 'tech-articles/dashboard/pages/_page_base.html' %}
{% load static %}
{% load i18n %}

{% block page_title %}{% translate 'Upload Resource' %}{% endblock %}

{% block extra_css %}
  <style>
    #drop-zone {
      transition: all 0.3s ease;
    }

    #drop-zone.dragging {
      transform: scale(1.02);
    }
  </style>
{% endblock %}

{% block page_content %}
  <div class="max-w-4xl mx-auto">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-white mb-1">{% translate "Upload Resource Document" %}</h1>
        <p
          class="text-text-secondary text-sm">{% translate "Upload documents, spreadsheets, presentations, or archives" %}</p>
      </div>
      <a href="{% url 'resources:resources_list' %}"
         class="btn-secondary">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        {% translate "Back" %}
      </a>
    </div>

    <!-- Main Form Card -->
    <div class="bg-surface-dark rounded-xl border border-border-dark p-6 md:p-8">
      <form method="post" id="resource-form" action="{% url 'resources:resources_create' %}"
            enctype="multipart/form-data">
        {% csrf_token %}

        <!-- File Upload Section -->
        <div class="mb-8" id="file-upload-section">
          <h2 class="text-lg font-semibold text-white mb-4">{% translate "Document File" %}</h2>

          <!-- Drag & Drop Zone -->
          <div id="drop-zone"
               class="border-2 border-dashed border-border-dark rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-colors">

            <!-- Drop Zone Content (shown when no file) -->
            <div id="drop-zone-content">
              <svg class="mx-auto h-12 w-12 text-text-muted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              <p class="text-white font-medium mb-1">{% translate "Drag and drop your file here" %}</p>
              <p class="text-text-secondary text-sm mb-4">{% translate "or" %}</p>
              <label for="file-input" class="btn-primary inline-block cursor-pointer">
                {% translate "Browse Files" %}
              </label>
              <input type="file" id="file-input" class="hidden"
                     accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.svg,.webp,.mp3,.wav,.ogg,.flac,.mp4,.mov,.avi,.mkv,.zip,.rar,.7z,.tar,.gz,.txt,.odt">
              <p class="text-text-muted text-xs mt-4">{% translate "Maximum file size: 100MB" %}</p>
            </div>

            <!-- File Info (shown when file selected) -->
            <div id="file-info" class="hidden">
              <div class="flex items-center justify-center mb-4">
                <div id="file-icon"></div>
              </div>
              <p class="text-white font-medium mb-1" id="file-name"></p>
              <p class="text-text-secondary text-sm" id="file-size"></p>
              <button type="button"
                      id="remove-file-btn"
                      class="mt-4 text-red-400 hover:text-red-300 text-sm transition-colors">
                {% translate "Remove file" %}
              </button>
            </div>

            <!-- Upload Progress -->
            <div id="progress-container-resource-file-upload" class="hidden mt-6">
              <div class="w-full bg-surface-light rounded-full h-2 mb-2">
                <div id="progress-bar-resource-file-upload"
                     class="bg-primary h-2 rounded-full transition-all duration-300"
                     style="width: 0"
                     role="progressbar"
                     aria-valuenow="0"
                     aria-valuemin="0"
                     aria-valuemax="100"></div>
              </div>
              <p id="status-resource-file-upload" class="text-text-secondary text-sm text-center"></p>
            </div>
          </div>
        </div>

        <!-- Resource Details -->
        <div class="space-y-6">
          <!-- Title -->
          <div>
            <label for="{{ form.title.id_for_label }}" class="form-label">
              {% translate "Title" %} <span class="text-red-500">*</span>
            </label>
            {{ form.title }}
            {% if form.title.errors %}
              <p class="form-error">{{ form.title.errors.0 }}</p>
            {% endif %}
          </div>

          <!-- Description -->
          <div>
            <label for="{{ form.description.id_for_label }}" class="form-label">
              {% translate "Description" %}
            </label>
            {{ form.description }}
            {% if form.description.errors %}
              <p class="form-error">{{ form.description.errors.0 }}</p>
            {% endif %}
          </div>

          <!-- Category and Article Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Category -->
            <div>
              <label for="{{ form.category.id_for_label }}" class="form-label">
                {% translate "Category" %}
              </label>
              {{ form.category }}
              {% if form.category.errors %}
                <p class="form-error">{{ form.category.errors.0 }}</p>
              {% endif %}
              <p class="form-help-text">{% translate "Optional: Select a category to filter articles" %}</p>
            </div>

            <!-- Article -->
            {% if form.article %}
              <div>
                <label for="{{ form.article.id_for_label }}" class="form-label">
                  {% translate "Article" %}
                </label>
                {{ form.article }}
                {% if form.article.errors %}
                  <p class="form-error">{{ form.article.errors.0 }}</p>
                {% endif %}
                <p class="form-help-text">{% translate "Optional: Link this resource to an article" %}</p>
              </div>
            {% endif %}
          </div>

          <!-- Access Level and Watermark Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Access Level -->
            <div>
              <label for="{{ form.access_level.id_for_label }}" class="form-label">
                {% translate "Access Level" %} <span class="text-red-500">*</span>
              </label>
              {{ form.access_level }}
              {% if form.access_level.errors %}
                <p class="form-error">{{ form.access_level.errors.0 }}</p>
              {% endif %}
            </div>

            <!-- Watermark Enabled -->
            <div>
              <label for="{{ form.watermark_enabled.id_for_label }}" class="form-label">
                {% translate "Watermark" %}
              </label>
              <div class="flex items-center mt-2">
                {{ form.watermark_enabled }}
                <span class="ml-2 text-text-secondary text-sm">{% translate "Enable watermark on document" %}</span>
              </div>
              {% if form.watermark_enabled.errors %}
                <p class="form-error">{{ form.watermark_enabled.errors.0 }}</p>
              {% endif %}
            </div>
          </div>

          <!-- Is Active -->
          <div>
            <div class="flex items-center">
              {{ form.is_active }}
              <label for="{{ form.is_active.id_for_label }}" class="ml-2 text-white">
                {% translate "Active" %}
              </label>
            </div>
            <p class="form-help-text ml-6">{% translate "Whether this resource is available for download" %}</p>
            {% if form.is_active.errors %}
              <p class="form-error ml-6">{{ form.is_active.errors.0 }}</p>
            {% endif %}
          </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-end gap-4 mt-8 pt-6 border-t border-border-dark">
          <button type="button" id="cancel-btn" class="btn-secondary">
            {% translate "Cancel" %}
          </button>
          <button type="submit" class="btn-primary">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            {% translate "Upload Resource" %}
          </button>
        </div>
      </form>
    </div>

    <!-- S3 Configuration Warning -->
    {% if not s3_configured %}
      <div class="mt-6 bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-4">
        <div class="flex items-start">
          <svg class="w-5 h-5 text-yellow-500 mr-3 shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
                  d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                  clip-rule="evenodd"></path>
          </svg>
          <div>
            <p class="text-yellow-500 font-medium">{% translate "AWS S3 Not Configured" %}</p>
            <p class="text-text-secondary text-sm mt-1">
              {% translate "S3 storage is not configured. File uploads will not work until AWS credentials are set up." %}
            </p>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block js %}
  <script src="{% static 'js/dashboard/resources/resource-upload-manager.js' %}"></script>
  <script src="{% static 'js/dashboard/resources/resource-form-handler.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      new ResourceFormHandler('resource-form', {
        isPopupMode: false,
        successUrl: '{% url "resources:resources_list" %}',
        cancelUrl: '{% url "resources:resources_list" %}',
        articlesByCategory: '{% url "resources:articles_by_category" %}',
        uploadEndpoints: {
          createEndpoint: '{% url 'resources:api_create_multipart_upload' %}',
          presignedUrlsEndpoint: '{% url 'resources:api_generate_presigned_urls' %}',
          completeEndpoint: '{% url 'resources:api_complete_multipart_upload' %}',
          abortEndpoint: '{% url 'resources:api_abort_multipart_upload' %}',
        }
      });
    });
  </script>
{% endblock %}


