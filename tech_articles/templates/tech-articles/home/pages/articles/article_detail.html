{% extends "tech-articles/home/base.html" %}
{% load static %}
{% load i18n %}
{% load markdown_filters %}

{% block content %}
  <div class="relative overflow-visible">
    <div class="absolute inset-0 overflow-hidden pointer-events-none rounded-[999px] bg-runbookly-gradient blur-[150px]
                  w-[30vw] h-[130vh] -top-[12vh] -left-[1vw] -rotate-[54.37deg]"></div>
    {% if not article %}
      <section class="relative pt-28 overflow-hidden">
        <div class="container-main">
          <div class="text-center py-20">
            <h1 class="text-4xl font-bold text-white mb-4">{% trans "Article Not Found" %}</h1>
            <p
              class="text-gray-400 mb-8">{% trans "The article you're looking for doesn't exist or has been removed." %}</p>
            <a href="{% url 'content:articles_list' %}"
               class="inline-block px-6 py-3 bg-primary text-background rounded-lg font-medium hover:bg-primary/90 transition-colors">
              {% trans "Browse Articles" %}
            </a>
          </div>
        </div>
      </section>
    {% else %}
      <section class="relative pt-28 overflow-hidden">
        <section class="article-detail-hero">

          <div class="container-main">
            <!-- Back button -->
            <button class="article-back-btn"
                    onclick="window.history.length > 1 ? window.history.back() : window.location.href='{% url 'content:articles_list' %}'"
                    aria-label="{% trans 'Go back' %}">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10.8008 12L14.7008 15.9C14.8841 16.0834 14.9758 16.3167 14.9758 16.6C14.9758 16.8834 14.8841 17.1167 14.7008 17.3C14.5175 17.4834 14.2841 17.575 14.0008 17.575C13.7175 17.575 13.4841 17.4834 13.3008 17.3L8.7008 12.7C8.6008 12.6 8.53013 12.4917 8.4888 12.375C8.44746 12.2584 8.42646 12.1334 8.4258 12C8.42513 11.8667 8.44613 11.7417 8.4888 11.625C8.53146 11.5084 8.60213 11.4 8.7008 11.3L13.3008 6.70005C13.4841 6.51672 13.7175 6.42505 14.0008 6.42505C14.2841 6.42505 14.5175 6.51672 14.7008 6.70005C14.8841 6.88338 14.9758 7.11672 14.9758 7.40005C14.9758 7.68338 14.8841 7.91672 14.7008 8.10005L10.8008 12Z"
                      fill="currentColor"/>
              </svg>
              {% trans "Back" %}
            </button>

            <div class="article-detail-badge-row">
              {% for category in article.categories.all %}
                <span class="third-featured-article-category">{{ category.name }}</span>
              {% empty %}
                <span class="third-featured-article-category">{% trans "Article" %}</span>
              {% endfor %}
            </div>

            <h1 class="article-detail-title">
              {{ article.title }}
            </h1>

            <p class="article-detail-description">
              {{ article.summary }}
            </p>

            <div class="article-detail-stats">
              <button class="article-stat-btn"
                      data-action="clap"
                      data-article-id="{{ article.id }}"
                      aria-label="{% trans 'Clap' %}">
                {% include "tech-articles/home/includes/components/__hand_clap_svg.html" %}
                <span class="article-stat-value" data-clap-count>{{ clap_count|default:0 }}</span>
              </button>

              <span class="article-stat-separator">|</span>

              <button class="article-stat-btn{% if user_has_liked %} liked{% endif %}"
                      data-action="like"
                      data-article-id="{{ article.id }}"
                      {% if not user.is_authenticated %}data-require-auth="true"{% endif %}
                      aria-label="{% trans 'Like' %}">
                {% include "tech-articles/home/includes/components/__heart_svg.html" %}
                <span class="article-stat-value" data-like-count>{{ like_count|default:0 }}</span>
              </button>

              <span class="article-stat-separator">|</span>

              <button class="article-stat-btn"
                      data-action="comment"
                {% if not is_last_page and has_multiple_pages %}
                      onclick="window.location.href='?page={{ total_pages }}#comments'"
                {% else %}
                      onclick="document.getElementById('comments').scrollIntoView({ behavior: 'smooth' })"
                {% endif %}
                      aria-label="{% trans 'Comments' %}">
                {% include "tech-articles/home/includes/components/__comment_svg.html" %}
                <span class="article-stat-value" data-comment-count>{{ comment_count|default:0 }}</span>
              </button>

              <span class="article-stat-separator">|</span>
              <span class="article-stat-meta">
              {% blocktrans count minutes=article.reading_time_minutes %}{{ minutes }} min read{% plural %}{{ minutes }}
                min read{% endblocktrans %}
            </span>
              {% if article.published_at %}
                <span class="article-stat-separator">Â·</span>
                <span class="article-stat-meta">{{ article.published_at|date:"d M Y" }}</span>
              {% endif %}
            </div>
          </div>
        </section>

        {% if article.cover_image and current_page == 1 %}
          <div class="article-detail-images">
            <div class="container-main">
              <div class="article-detail-images-grid">
                <img src="{{ article.get_cover_image_url }}"
                     alt="{{ article.cover_alt_text|default:article.title }}"
                     class="article-detail-img">
              </div>
            </div>
          </div>
        {% endif %}
      </section>
      <section class="article-detail-main">
        <div class="container-main">
          <div class="article-detail-layout">

            <div class="article-content-col">

              {# Render article content from markdown with pagination support #}
              {% if current_page_content %}
                {# Multi-page article - render current page #}
                <div class="article-prose">
                  {{ current_page_content.content|markdown_to_html }}
                </div>
              {% elif article.pages.exists %}
                {# Has pages but current_page_content is None - show first page as fallback #}
                {% for page in article.pages.all %}
                  {% if forloop.first %}
                    <div class="article-prose">
                      {{ page.content|markdown_to_html }}
                    </div>
                  {% endif %}
                {% endfor %}
              {% else %}
                {# No pages - Show preview content if available #}
                {% if article.preview_content %}
                  <div class="article-prose">
                    {{ article.preview_content|markdown_to_html }}
                  </div>
                {% else %}
                  <div class="article-prose">
                    <p class="text-gray-400 text-sm sm:text-base leading-relaxed mb-4">
                      {% trans "Content will be available soon." %}
                    </p>
                  </div>
                {% endif %}
              {% endif %}

              {# Article Pagination - only show if article has multiple pages #}
              {% if has_multiple_pages %}
                <nav class="article-detail-pagination" aria-label="{% trans 'Article navigation' %}">
                  <button class="article-pagination-btn article-pagination-prev"
                          data-action="prev-page"
                          {% if not has_prev_page %}disabled{% endif %}
                          onclick="window.location.href='?page={{ prev_page }}'">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M10.8008 12L14.7008 15.9C14.8841 16.0834 14.9758 16.3167 14.9758 16.6C14.9758 16.8834 14.8841 17.1167 14.7008 17.3C14.5175 17.4834 14.2841 17.575 14.0008 17.575C13.7175 17.575 13.4841 17.4834 13.3008 17.3L8.7008 12.7C8.6008 12.6 8.53013 12.4917 8.4888 12.375C8.44746 12.2584 8.42646 12.1334 8.4258 12C8.42513 11.8667 8.44613 11.7417 8.4888 11.625C8.53146 11.5084 8.60213 11.4 8.7008 11.3L13.3008 6.70005C13.4841 6.51672 13.7175 6.42505 14.0008 6.42505C14.2841 6.42505 14.5175 6.51672 14.7008 6.70005C14.8841 6.88338 14.9758 7.11672 14.9758 7.40005C14.9758 7.68338 14.8841 7.91672 14.7008 8.10005L10.8008 12Z"
                        fill="currentColor"></path>
                    </svg>
                    <span class="translate-y-px">{% trans "Prev" %}</span>
                  </button>
                  <span class="text-white text-sm">
                    {% blocktrans with current=current_page total=total_pages %}Page {{ current }} of
                      {{ total }}{% endblocktrans %}
                  </span>
                  <button class="article-pagination-btn article-pagination-next"
                          data-action="next-page"
                          {% if not has_next_page %}disabled{% endif %}
                          onclick="window.location.href='?page={{ next_page }}'">
                    <span class="translate-y-px">{% trans "Next" %}</span>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M12.6008 12L8.70078 8.10005C8.51745 7.91672 8.42578 7.68338 8.42578 7.40005C8.42578 7.11672 8.51745 6.88338 8.70078 6.70005C8.88411 6.51672 9.11745 6.42505 9.40078 6.42505C9.68411 6.42505 9.91745 6.51672 10.1008 6.70005L14.7008 11.3C14.8008 11.4 14.8718 11.5084 14.9138 11.625C14.9558 11.7417 14.9764 11.8667 14.9758 12C14.9751 12.1334 14.9544 12.2584 14.9138 12.375C14.8731 12.4917 14.8021 12.6 14.7008 12.7L10.1008 17.3C9.91745 17.4834 9.68411 17.575 9.40078 17.575C9.11745 17.575 8.88411 17.4834 8.70078 17.3C8.51745 17.1167 8.42578 16.8834 8.42578 16.6C8.42578 16.3167 8.51745 16.0834 8.70078 15.9L12.6008 12Z"
                        fill="currentColor"></path>
                    </svg>
                  </button>
                </nav>
              {% endif %}

              <div class="article-resources">
                <h3 class="article-resources-title">{% trans "Ressources" %}</h3>
                <ul class="article-resources-list">
                  <li class="article-resource-item">
                    {% include "tech-articles/home/includes/components/__open_box_svg.html" %}
                    <a href="#" class="article-resource-link">{% trans "React structure components and hierarchy" %}</a>
                  </li>
                  <li class="article-resource-item">
                    {% include "tech-articles/home/includes/components/__open_box_svg.html" %}
                    <a href="#" class="article-resource-link">{% trans "Alternative structure to React context" %}</a>
                  </li>
                  <li class="article-resource-item">
                    {% include "tech-articles/home/includes/components/__open_box_svg.html" %}
                    <a href="#"
                       class="article-resource-link">{% trans "The CI/CD Handbook: Learn Continuous Integration and Delivery." %}</a>
                  </li>
                </ul>
              </div>

              {# ---- Comments Section - Only show on last page ---- #}
              {% if is_last_page %}
                <div class="article-comments" id="comments">
                  <h3 class="article-comments-title">{% trans "Comments" %} <span
                    class="article-comments-count" data-comments-section-count>({{ comment_count|default:0 }})</span>
                  </h3>

                  {# Comment form - avatar/username above, card below #}
                  {% if user.is_authenticated %}
                    <div class="article-comment-form-header">
                      <span
                        class="h-8 w-8 md:h-10 md:w-10 overflow-hidden rounded-full ring-2 ring-border-dark flex items-center justify-center">
                        {% if user.get_avatar_url %}
                          <img src="{{ user.get_avatar_url }}"
                               class="article-avatar-img"
                               alt=""/>
                        {% else %}
                          <svg class="article-avatar-img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40">
                            <circle cx="20" cy="20" r="20" fill="#35354A"></circle>
                            <text x="20" y="26" text-anchor="middle" font-size="16" fill="#A0A0B0">
                              {{ user.name|default:user.email|slice:':1'|upper }}
                            </text>
                          </svg>
                        {% endif %}
                      </span>

                      <span class="article-comment-form-username">{{ user.name|default:user.email }}</span>
                    </div>
                    <div class="article-comment-form">
                      <textarea class="article-comment-textarea"
                                data-comment-textarea
                                placeholder="{% trans 'What are your thoughts?' %}"
                                rows="4"></textarea>
                      <div class="article-comment-form-actions">
                        <button type="button" class="article-comment-cancel"
                                data-comment-cancel>{% trans "Cancel" %}</button>
                        <button type="button" class="article-comment-submit"
                                data-comment-submit>{% trans "Respond" %}</button>
                      </div>
                    </div>
                  {% else %}
                    <div class="bg-[#23233A] border border-[#4C4C4C] rounded-xl p-5 mb-10 text-center">
                      <p class="text-gray-400 mb-4">{% trans "Please log in to leave a comment." %}</p>
                      <a href="{% url 'accounts:account_login' %}"
                         class="inline-block px-6 py-2 bg-primary text-background rounded-full font-medium hover:bg-primary/90 transition-colors">
                        {% trans "Log In" %}
                      </a>
                    </div>
                  {% endif %}

                  <div class="article-comments-list" data-comments-list>
                    {% for comment in comments %}
                      <div class="article-comment-item" data-comment-id="{{ comment.id }}">
                        <div class="article-comment-avatar-col">
                          <div class="article-avatar-placeholder" style="background-color: #4B5563;">
                            <span>{{ comment.user.name|default:comment.user.email|slice:':1'|upper }}</span>
                          </div>
                        </div>
                        <div class="article-comment-body">
                          <div class="article-comment-header">
                            <span
                              class="article-comment-author">{{ comment.user.name|default:comment.user.email }}</span>
                            <span class="article-comment-date">{{ comment.created_at|date:"d M Y" }}</span>
                          </div>
                          <p class="article-comment-text">{{ comment.content }}</p>
                          <div class="article-comment-footer">
                            {% if user.is_authenticated %}
                              <button
                                class="article-comment-like-btn{% if comment.id in user_liked_comment_ids %} liked{% endif %}"
                                data-comment-like="{{ comment.id }}"
                                aria-label="{% trans 'Like comment' %}">
                                {% include "tech-articles/home/includes/components/__heart_svg.html" %}
                                <span data-comment-like-count="{{ comment.id }}">{{ comment.likes.count }}</span>
                              </button>
                            {% else %}
                              <button class="article-comment-like-btn article-comment-like-btn--empty"
                                      data-comment-like="{{ comment.id }}"
                                      data-require-auth="true"
                                      aria-label="{% trans 'Like comment' %}">
                                {% include "tech-articles/home/includes/components/__heart_svg.html" %}
                                <span data-comment-like-count="{{ comment.id }}">{{ comment.likes.count }}</span>
                              </button>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% empty %}
                      <div class="text-center py-8">
                        <p class="text-gray-400">{% trans "No comments yet. Be the first to comment!" %}</p>
                      </div>
                    {% endfor %}
                  </div>

                  {% if comments|length > 10 %}
                    <button class="article-view-all-comments">{% trans "View all comments" %}</button>
                  {% endif %}
                </div>
              {% endif %}

            </div>

            <aside class="related-articles-panel">
              <div>
                {% if toc %}
                  <div class="mb-16">
                    <h3 class="articles-listing-section-title">{% trans "Table of Contents" %}</h3>
                    <nav id="toc-nav" class="toc-nav ml-4">
                      {% include "tech-articles/home/includes/components/_toc.html" with items=toc %}
                    </nav>
                  </div>
                {% endif %}
                <h3 class="articles-listing-section-title">{% trans "Related articles" %}</h3>
                <div class="related-articles-list relative">
                  {% include "tech-articles/home/includes/components/_related_article_card.html" with category="Frontend" read_time=5 title="Building scalable frontend architecture" description="Design systems, shared patterns, and clear ownership models for large products." link="#" %}
                  {% include "tech-articles/home/includes/components/_related_article_card.html" with category="DevOps" read_time=4 title="Automating deployment with GitHub Actions" description="A practical guide to pipeline stages, approvals, and safe release strategies." link="#" %}
                  <!-- Background decorative element (mirrored from hero - positioned right) -->
                  <div
                    class="absolute pointer-events-none rounded-[999px] bg-runbookly-gradient blur-[150px]
                   w-[20vw] h-[120vh]
                   top-[20%] z-5 -right-[3vw] rotate-[54.37deg]"
                    aria-hidden="true"
                  ></div>
                  {% include "tech-articles/home/includes/components/_related_article_card.html" with category="JavaScript" read_time=6 title="Clean code principles with JavaScript" description="How to keep JS codebases readable and maintainable with real-world examples." link="#" %}
                  {% include "tech-articles/home/includes/components/_related_article_card.html" with category="Performance" read_time=7 title="Advanced caching strategies with Redis" description="Cache-aside, write-through, and invalidation techniques for modern apps." link="#" %}
                </div>
              </div>

              <div class="related-cta-card">
                <div class="related-cta-content">
                  <h4 class="related-cta-title">{% trans "Enjoyed these articles ?" %}</h4>
                  <p class="related-cta-description">
                    {% trans "Get access to premium contents and stay updated with new technical insights." %}
                  </p>
                </div>
                <div class="related-cta-actions">
                  <a href="{% url 'common:home' %}#pricing" class="btn-primary">{% trans "Subscribe" %}</a>
                  <a href="{% url 'common:home' %}#newsletter"
                     class="btn-secondary">{% trans "Join the Newsletter" %}</a>
                </div>
              </div>
            </aside>
          </div>
        </div>
      </section>
    {% endif %}
  </div>
  {% csrf_token %}
  {% include "tech-articles/home/includes/components/_auth_required_modal.html" %}
{% endblock %}

{% block js %}
  <!-- Article Interactions JS -->
  <script>
    window.urls = {
      articleClap: (id) => `{% url 'content:api_article_clap' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id),
      articleLike: (id) => `{% url 'content:api_article_like' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id),
      articleComments: (id) => `{% url 'content:api_article_comments' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id),
      articleCommentLike: (id) => `{% url 'content:api_comment_like' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id),
    }
  </script>
  <script src="{% static 'js/home/articles/article-interactions.js' %}"></script>
  {% if toc %}
    <script src="{% static 'js/home/articles/toc-tracker.js' %}"></script>
  {% endif %}
{% endblock %}
