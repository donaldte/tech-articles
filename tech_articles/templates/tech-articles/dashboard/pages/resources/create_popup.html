{% extends 'tech-articles/dashboard/base_blank.html' %}
{% load i18n static %}

{% block title %}{% translate "Upload Resource" %} - Runbookly{% endblock %}

{% block extra_css %}
<style>
  #drop-zone {
    transition: all 0.3s ease;
  }

  #drop-zone.dragging {
    transform: scale(1.02);
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-background p-6">
  <div class="max-w-3xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-white mb-2">{% translate "Upload Resource Document" %}</h1>
      <p class="text-text-secondary">{% translate "This resource will be linked to your article" %}</p>
    </div>

    <!-- Form Card -->
    <div class="bg-surface-dark rounded-xl border border-border-dark p-6">
      <form method="post" id="resource-popup-form" action="{% url 'resources:resources_create_popup' %}" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- File Upload Section -->
        <div class="mb-6" id="file-upload-section">
          <h3 class="text-base font-semibold text-white mb-3">{% translate "Document File" %}</h3>

          <!-- Drag & Drop Zone -->
          <div id="drop-zone"
               class="border-2 border-dashed border-border-dark rounded-lg p-6 text-center cursor-pointer hover:border-primary transition-colors">

            <!-- Drop Zone Content -->
            <div id="drop-zone-content">
              <svg class="mx-auto h-10 w-10 text-text-muted mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              <p class="text-white text-sm font-medium mb-1">{% translate "Drag and drop your file here" %}</p>
              <p class="text-text-secondary text-xs mb-3">{% translate "or" %}</p>
              <label for="file-input" class="btn-primary inline-block cursor-pointer text-sm px-4 py-2">
                {% translate "Browse Files" %}
              </label>
              <input type="file" id="file-input" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.svg,.webp,.mp3,.wav,.ogg,.flac,.mp4,.mov,.avi,.mkv,.zip,.rar,.7z,.tar,.gz,.txt,.odt">
              <p class="text-text-muted text-xs mt-3">{% translate "Maximum file size: 100MB" %}</p>
            </div>

            <!-- File Info -->
            <div id="file-info" class="hidden">
              <div class="flex items-center justify-center mb-3">
                <div id="file-icon"></div>
              </div>
              <p class="text-white font-medium text-sm mb-1" id="file-name"></p>
              <p class="text-text-secondary text-xs" id="file-size"></p>
              <button type="button"
                      id="remove-file-btn"
                      class="mt-3 text-red-400 hover:text-red-300 text-xs transition-colors">
                {% translate "Remove file" %}
              </button>
            </div>

            <!-- Upload Progress -->
            <div id="progress-container-resource-file-upload" class="hidden mt-4 mx-auto w-full min-[500px]:w-1/2">
              <div class="w-full bg-surface-light rounded-full h-2 mb-2">
                <div id="progress-bar-resource-file-upload"
                     class="bg-primary h-2 rounded-full transition-all duration-300"
                     style="width: 0"></div>
              </div>
              <p id="status-resource-file-upload" class="text-text-secondary text-xs text-center"></p>
            </div>
          </div>
        </div>

        <!-- Resource Details -->
        <div class="space-y-4">
          <!-- Title -->
          <div>
            <label for="{{ form.title.id_for_label }}" class="form-label text-sm">
              {% translate "Title" %} <span class="text-red-500">*</span>
            </label>
            {{ form.title }}
            {% if form.title.errors %}
              <p class="form-error text-xs">{{ form.title.errors.0 }}</p>
            {% endif %}
          </div>

          <!-- Description -->
          <div>
            <label for="{{ form.description.id_for_label }}" class="form-label text-sm">
              {% translate "Description" %}
            </label>
            {{ form.description }}
            {% if form.description.errors %}
              <p class="form-error text-xs">{{ form.description.errors.0 }}</p>
            {% endif %}
          </div>

          <!-- Category (filtered) -->
          <div>
            <label for="{{ form.category.id_for_label }}" class="form-label text-sm">
              {% translate "Category" %}
            </label>
            {{ form.category }}
            {% if form.category.errors %}
              <p class="form-error text-xs">{{ form.category.errors.0 }}</p>
            {% endif %}
            <p class="form-help-text text-xs">
              {% if article_categories %}
                {% translate "Categories from the article" %}
              {% else %}
                {% translate "Optional" %}
              {% endif %}
            </p>
          </div>

          <!-- Access Level and Watermark -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="{{ form.access_level.id_for_label }}" class="form-label text-sm">
                {% translate "Access Level" %}
              </label>
              {{ form.access_level }}
              {% if form.access_level.errors %}
                <p class="form-error text-xs">{{ form.access_level.errors.0 }}</p>
              {% endif %}
            </div>

            <div>
              <label for="{{ form.watermark_enabled.id_for_label }}" class="form-label text-sm">
                {% translate "Watermark" %}
              </label>
              <div class="flex items-center mt-2">
                {{ form.watermark_enabled }}
                <span class="ml-2 text-text-secondary text-xs">{% translate "Enable" %}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-end gap-3 mt-6 pt-4 border-t border-border-dark">
          <button type="button" id="cancel-btn" class="btn-secondary text-sm px-4 py-2">
            {% translate "Cancel" %}
          </button>
          <button type="submit" class="btn-primary text-sm px-4 py-2">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            {% translate "Upload & Link" %}
          </button>
        </div>
      </form>
    </div>

    <!-- S3 Warning -->
    {% if not s3_configured %}
    <div class="mt-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3">
      <div class="flex items-start">
        <svg class="w-4 h-4 text-yellow-500 mr-2 shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
        <div>
          <p class="text-yellow-500 text-xs font-medium">{% translate "AWS S3 Not Configured" %}</p>
          <p class="text-text-secondary text-xs mt-0.5">{% translate "File uploads will not work." %}</p>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block js %}
<script src="{% static 'js/dashboard/resources/resource-upload-manager.js' %}"></script>
<script src="{% static 'js/dashboard/resources/resource-form-handler.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    new ResourceFormHandler('resource-popup-form', {
      isPopupMode: true,
    });
  });
</script>
{% endblock %}

