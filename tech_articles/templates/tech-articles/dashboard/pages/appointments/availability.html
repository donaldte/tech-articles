{% extends 'tech-articles/dashboard/pages/_page_base.html' %}
{% load i18n static %}

{% block page_title %}{% translate 'Availability Settings' %}{% endblock %}

{% block page_content %}
<div class="space-y-6">
    <!-- Configuration Section -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold mb-4">{% translate 'Global Configuration' %}</h2>
        <form id="config-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% csrf_token %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    {% translate 'Slot Duration (minutes)' %}
                </label>
                {{ config_form.slot_duration_minutes }}
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    {% translate 'Max Appointments per Slot' %}
                </label>
                {{ config_form.max_appointments_per_slot }}
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    {% translate 'Timezone' %}
                </label>
                <select name="timezone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <option value="UTC" {% if config.timezone == 'UTC' %}selected{% endif %}>UTC</option>
                    <option value="America/New_York" {% if config.timezone == 'America/New_York' %}selected{% endif %}>America/New_York (EST/EDT)</option>
                    <option value="America/Chicago" {% if config.timezone == 'America/Chicago' %}selected{% endif %}>America/Chicago (CST/CDT)</option>
                    <option value="America/Denver" {% if config.timezone == 'America/Denver' %}selected{% endif %}>America/Denver (MST/MDT)</option>
                    <option value="America/Los_Angeles" {% if config.timezone == 'America/Los_Angeles' %}selected{% endif %}>America/Los_Angeles (PST/PDT)</option>
                    <option value="Europe/Paris" {% if config.timezone == 'Europe/Paris' %}selected{% endif %}>Europe/Paris (CET/CEST)</option>
                    <option value="Europe/London" {% if config.timezone == 'Europe/London' %}selected{% endif %}>Europe/London (GMT/BST)</option>
                    <option value="Asia/Tokyo" {% if config.timezone == 'Asia/Tokyo' %}selected{% endif %}>Asia/Tokyo (JST)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    {% translate 'Minimum Booking Delay (hours)' %}
                </label>
                {{ config_form.minimum_booking_hours }}
            </div>
            <div class="md:col-span-2">
                <button type="submit" class="bg-primary-600 text-white px-6 py-2 rounded-md hover:bg-primary-700 transition-colors">
                    {% translate 'Save Configuration' %}
                </button>
            </div>
        </form>
    </div>

    <!-- Weekly Calendar -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">{% translate 'Weekly Schedule' %}</h2>
            <button id="add-availability-btn" class="bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 transition-colors">
                {% translate 'Add Time Slot' %}
            </button>
        </div>
        
        <!-- Calendar Grid -->
        <div id="weekly-calendar" class="overflow-x-auto">
            <div class="min-w-[900px]">
                <!-- Days Header -->
                <div class="grid grid-cols-8 gap-2 mb-2">
                    <div class="text-sm font-medium text-gray-500 text-center">{% translate 'Time' %}</div>
                    <div class="text-sm font-medium text-gray-700 text-center py-2 bg-gray-50 rounded">{% translate 'Monday' %}</div>
                    <div class="text-sm font-medium text-gray-700 text-center py-2 bg-gray-50 rounded">{% translate 'Tuesday' %}</div>
                    <div class="text-sm font-medium text-gray-700 text-center py-2 bg-gray-50 rounded">{% translate 'Wednesday' %}</div>
                    <div class="text-sm font-medium text-gray-700 text-center py-2 bg-gray-50 rounded">{% translate 'Thursday' %}</div>
                    <div class="text-sm font-medium text-gray-700 text-center py-2 bg-gray-50 rounded">{% translate 'Friday' %}</div>
                    <div class="text-sm font-medium text-gray-700 text-center py-2 bg-gray-50 rounded">{% translate 'Saturday' %}</div>
                    <div class="text-sm font-medium text-gray-700 text-center py-2 bg-gray-50 rounded">{% translate 'Sunday' %}</div>
                </div>
                
                <!-- Time Slots Grid -->
                <div id="calendar-body" class="relative">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Availability Rules List -->
        <div class="mt-6">
            <h3 class="text-lg font-medium mb-3">{% translate 'Current Availability Rules' %}</h3>
            <div id="rules-list" class="space-y-2">
                {% for rule in availability_rules %}
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-md" data-rule-id="{{ rule.id }}">
                    <div class="flex items-center space-x-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {{ rule.get_weekday_display }}
                        </span>
                        <span class="text-sm text-gray-700">
                            {{ rule.start_time|time:"H:i" }} - {{ rule.end_time|time:"H:i" }}
                        </span>
                        {% if rule.is_recurring %}
                        <span class="text-xs text-gray-500">({% translate 'Recurring' %})</span>
                        {% endif %}
                    </div>
                    <button onclick="deleteRule('{{ rule.id }}')" class="text-red-600 hover:text-red-800 text-sm">
                        {% translate 'Delete' %}
                    </button>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm">{% translate 'No availability rules defined yet.' %}</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Exception Dates -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">{% translate 'Exception Dates' %}</h2>
            <button id="add-exception-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                {% translate 'Add Exception' %}
            </button>
        </div>
        
        <div id="exceptions-list" class="space-y-2">
            {% for exception in exception_dates %}
            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-md" data-exception-id="{{ exception.id }}">
                <div class="flex items-center space-x-3">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        {{ exception.date }}
                    </span>
                    <span class="text-sm text-gray-700">{{ exception.reason }}</span>
                </div>
                <button onclick="deleteException('{{ exception.id }}')" class="text-red-600 hover:text-red-800 text-sm">
                    {% translate 'Delete' %}
                </button>
            </div>
            {% empty %}
            <p class="text-gray-500 text-sm">{% translate 'No exception dates defined.' %}</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add Availability Rule Modal -->
<div id="availability-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">{% translate 'Add Availability Rule' %}</h3>
            <form id="availability-form" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% translate 'Day of Week' %}</label>
                    <select name="weekday" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="mon">{% translate 'Monday' %}</option>
                        <option value="tue">{% translate 'Tuesday' %}</option>
                        <option value="wed">{% translate 'Wednesday' %}</option>
                        <option value="thu">{% translate 'Thursday' %}</option>
                        <option value="fri">{% translate 'Friday' %}</option>
                        <option value="sat">{% translate 'Saturday' %}</option>
                        <option value="sun">{% translate 'Sunday' %}</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% translate 'Start Time' %}</label>
                    <input type="time" name="start_time" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% translate 'End Time' %}</label>
                    <input type="time" name="end_time" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" name="is_recurring" checked class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                    <label class="ml-2 block text-sm text-gray-700">{% translate 'Recurring weekly' %}</label>
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 transition-colors">
                        {% translate 'Add' %}
                    </button>
                    <button type="button" onclick="closeAvailabilityModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">
                        {% translate 'Cancel' %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Exception Date Modal -->
<div id="exception-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">{% translate 'Add Exception Date' %}</h3>
            <form id="exception-form" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% translate 'Date' %}</label>
                    <input type="date" name="date" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% translate 'Reason' %}</label>
                    <input type="text" name="reason" placeholder="{% translate 'Holiday, vacation, etc.' %}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500">
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                        {% translate 'Add' %}
                    </button>
                    <button type="button" onclick="closeExceptionModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors">
                        {% translate 'Cancel' %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
// Internationalization for JavaScript
window.i18nMessages = {
    confirmDeleteRule: "{% translate 'Are you sure you want to delete this availability rule?' %}",
    confirmDeleteException: "{% translate 'Are you sure you want to delete this exception date?' %}",
    recurring: "{% translate 'Recurring' %}",
    delete: "{% translate 'Delete' %}"
};
</script>
<script src="{% static 'js/dashboard/availability-calendar.js' %}"></script>
{% endblock %}
