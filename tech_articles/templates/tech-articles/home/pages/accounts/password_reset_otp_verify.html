{% load i18n %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{% trans "Verify password reset" %} - Runbookly</title>
</head>
<body>
  <h1>{% trans "Verify your password reset" %}</h1>
  <p>{% blocktrans with email=masked_email %}We sent a verification code to {{ email }}. Enter it below to reset your password.{% endblocktrans %}</p>
  <form method="post">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <div>
      {{ form.code.label_tag }}<br>
      {{ form.code }}
      {{ form.code.errors }}
    </div>
    <button type="submit">{% trans "Verify" %}</button>
  </form>
  <p>
    <button type="button" id="resend-otp" data-purpose="password_reset_verification">{% trans "Resend code" %}</button>
  </p>
  <script>
    document.getElementById('resend-otp').addEventListener('click', function() {
      const button = this;
      const purpose = button.dataset.purpose;

      button.disabled = true;
      button.textContent = '{% trans "Sending..." %}';

      fetch('{% url "accounts:otp_resend" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'purpose=' + purpose
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
        } else {
          alert(data.error);
        }
        button.disabled = false;
        button.textContent = '{% trans "Resend code" %}';
      })
      .catch(error => {
        alert('{% trans "Error sending code. Please try again." %}');
        button.disabled = false;
        button.textContent = '{% trans "Resend code" %}';
      });
    });
  </script>
</body>
</html>
