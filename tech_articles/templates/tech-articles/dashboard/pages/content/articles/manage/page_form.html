{% extends 'tech-articles/dashboard/pages/content/articles/manage/base_blank.html' %}
{% load i18n %}

{#
  Article Page Form with TUI Editor Integration
  
  This template provides a markdown editor powered by Toast UI Editor for creating
  and editing article page content.
  
  Features:
  - Toast UI Editor v3.x with markdown editing
  - Dark theme matching dashboard design
  - Internationalization support (fr, es, en)
  - Dual editors: main content + preview content
  - Auto-sync markdown to form fields on submission
  
  TUI Editor Configuration:
  - Height: 600px (main), 300px (preview)
  - Edit Type: Markdown only
  - Preview Style: Vertical split
  - Theme: Dark (toastui-editor-dark)
  - Language: Based on request.LANGUAGE_CODE
  
  Form Fields:
  - page_number: Sequential page number (required)
  - title: Optional page title
  - content: Markdown content (required, hidden textarea synced with editor)
  - preview_content: Markdown preview (optional, hidden textarea synced with editor)
#}

{% block css %}
  <!-- TUI Editor CSS -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/theme/toastui-editor-dark.min.css">
  
  <style>
    /* Custom styles to blend TUI Editor with dashboard dark theme */
    .toastui-editor-defaultUI {
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      border-radius: 0.5rem !important;
      overflow: hidden;
    }
    
    .toastui-editor-toolbar {
      background-color: #1a1a1a !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    }
    
    .toastui-editor-main-container {
      background-color: #0d0d0d !important;
    }
    
    .toastui-editor-md-container,
    .toastui-editor-md-preview {
      background-color: #0d0d0d !important;
      color: #e5e5e5 !important;
    }
    
    /* Scrollbar styling for editor */
    .toastui-editor-md-container::-webkit-scrollbar,
    .toastui-editor-md-preview::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    .toastui-editor-md-container::-webkit-scrollbar-track,
    .toastui-editor-md-preview::-webkit-scrollbar-track {
      background: #1a1a1a;
    }
    
    .toastui-editor-md-container::-webkit-scrollbar-thumb,
    .toastui-editor-md-preview::-webkit-scrollbar-thumb {
      background: #404040;
      border-radius: 4px;
    }
    
    .toastui-editor-md-container::-webkit-scrollbar-thumb:hover,
    .toastui-editor-md-preview::-webkit-scrollbar-thumb:hover {
      background: #505050;
    }
  </style>
{% endblock %}


{% block main %}
  <main id="main-content" class="bg-surface-darker h-screen overflow-y-auto">
    <div class="py-8 md:py-10 px-10 md:px-12 mx-auto w-full">
      <!-- Header with Back Button and Breadcrumb -->
      <div class="mb-6 flex items-center justify-between gap-4">
        <!-- Back Button -->
        <a href="{% url 'content:article_manage_content' pk=article.pk %}"
           class="inline-flex items-center justify-center p-2 rounded-lg text-text-secondary hover:text-primary hover:bg-surface-light transition-colors flex-shrink-0"
           title="{% translate 'Go back to page list' %}">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
               stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5"></path>
          </svg>
        </a>

        <!-- Breadcrumb -->
        <nav class="flex-1 min-w-0" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2 text-sm text-text-muted flex-wrap justify-end">
            <li class="hidden sm:block">
              <a href="{% url 'content:articles_list' %}" class="hover:text-primary transition-colors">
                {% translate "Articles" %}
              </a>
            </li>
            <li class="hidden sm:block">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
            </li>
            <li class="hidden sm:block truncate">
              <a href="{% url 'content:article_manage_details' pk=article.pk %}" class="hover:text-primary transition-colors truncate">
                {{ article.title|truncatechars:20 }}
              </a>
            </li>
            <li class="hidden sm:block">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
            </li>
            <li>
              <a href="{% url 'content:article_manage_content' pk=article.pk %}" class="hover:text-primary transition-colors">
                {% translate "Content" %}
              </a>
            </li>
            <li>
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
            </li>
            <li class="text-text-primary font-medium truncate">
              {{ page_title }}
            </li>
          </ol>
        </nav>
      </div>

      <!-- Form Card -->
      <div class="bg-surface-dark p-6 md:p-8 rounded-xl border border-border-dark">
        <div class="mb-6">
          <h2 class="text-xl md:text-2xl font-bold text-text-primary">{{ page_title }}</h2>
          <p class="text-text-muted text-sm mt-1">
            {% if is_edit %}
              {% translate "Update the content and details for this page." %}
            {% else %}
              {% translate "Add a new page to your article with content in Markdown/MDX format." %}
            {% endif %}
          </p>
        </div>

        <form method="post" class="space-y-6">
          {% csrf_token %}

          <!-- Page Number + Title Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Page Number -->
            <div>
              <label for="id_page_number" class="block text-sm font-medium text-text-primary mb-2">
                {% translate "Page Number" %} <span class="text-red-500">*</span>
              </label>
              <input type="number" name="page_number" id="id_page_number"
                     value="{{ form.page_number.value|default:'' }}"
                     min="1"
                     class="dashboard-input w-full {% if form.page_number.errors %}border-red-500{% endif %}"
                     required>
              {% if form.page_number.errors %}
                <p class="text-red-500 text-xs mt-1">{{ form.page_number.errors.0 }}</p>
              {% else %}
                <p class="text-text-muted text-xs mt-1">{% translate "Sequential number for ordering pages" %}</p>
              {% endif %}
            </div>

            <!-- Title -->
            <div>
              <label for="id_title" class="block text-sm font-medium text-text-primary mb-2">
                {% translate "Title" %}
              </label>
              <input type="text" name="title" id="id_title"
                     value="{{ form.title.value|default:'' }}"
                     placeholder="{% translate 'Optional page title' %}"
                     class="dashboard-input w-full {% if form.title.errors %}border-red-500{% endif %}">
              {% if form.title.errors %}
                <p class="text-red-500 text-xs mt-1">{{ form.title.errors.0 }}</p>
              {% else %}
                <p class="text-text-muted text-xs mt-1">{% translate "Leave blank to use default 'Page X' title" %}</p>
              {% endif %}
            </div>
          </div>

          <!-- Content -->
          <div>
            <label for="id_content" class="block text-sm font-medium text-text-primary mb-2">
              {% translate "Content" %} <span class="text-red-500">*</span>
            </label>
            <div id="content-editor" class="{% if form.content.errors %}border-2 border-red-500 rounded{% endif %}"></div>
            <textarea name="content" id="id_content" style="display: none;"
                      required>{{ form.content.value|default:'' }}</textarea>
            {% if form.content.errors %}
              <p class="text-red-500 text-xs mt-1">{{ form.content.errors.0 }}</p>
            {% else %}
              <p class="text-text-muted text-xs mt-1">{% translate "Use Markdown format for rich content" %}</p>
            {% endif %}
          </div>

          <!-- Preview Content -->
          <div>
            <label for="id_preview_content" class="block text-sm font-medium text-text-primary mb-2">
              {% translate "Preview Content" %}
            </label>
            <div id="preview-editor" class="{% if form.preview_content.errors %}border-2 border-red-500 rounded{% endif %}"></div>
            <textarea name="preview_content" id="id_preview_content" style="display: none;">{{ form.preview_content.value|default:'' }}</textarea>
            {% if form.preview_content.errors %}
              <p class="text-red-500 text-xs mt-1">{{ form.preview_content.errors.0 }}</p>
            {% else %}
              <p
                class="text-text-muted text-xs mt-1">{% translate "This content will be visible to users before they purchase access" %}</p>
            {% endif %}
          </div>

          <!-- Form Actions -->
          <div
            class="flex flex-col-reverse sm:flex-row items-center justify-between gap-3 pt-6 border-t border-border-dark">
            <a href="{% url 'content:article_manage_content' pk=article.pk %}"
               class="w-full sm:w-auto px-6 py-2.5 rounded-full bg-surface-light text-text-primary hover:bg-surface-lighter text-center transition-colors">
              {% translate "Cancel" %}
            </a>
            <button type="submit"
                    class="w-full md:w-fit btn-primary px-6 py-2.5">
              {% if is_edit %}
                {% translate "Update Page" %}
              {% else %}
                {% translate "Create Page" %}
              {% endif %}
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>
{% endblock %}

{% block js %}
  <!-- TUI Editor JS and i18n -->
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  {% if request.LANGUAGE_CODE == 'fr' %}
    <script src="https://uicdn.toast.com/editor/latest/i18n/fr-fr.js"></script>
  {% elif request.LANGUAGE_CODE == 'es' %}
    <script src="https://uicdn.toast.com/editor/latest/i18n/es-es.js"></script>
  {% endif %}

  <script>
    (function() {
      'use strict';

      // Get the user's language code
      const languageCode = '{{ request.LANGUAGE_CODE }}';
      
      // Map Django language codes to TUI Editor language codes
      const languageMap = {
        'fr': 'fr-FR',
        'es': 'es-ES',
        'en': 'en-US'
      };
      
      const editorLanguage = languageMap[languageCode] || 'en-US';

      // Initialize main content editor
      const contentEditor = new toastui.Editor({
        el: document.querySelector('#content-editor'),
        height: '600px',
        initialEditType: 'markdown',
        previewStyle: 'vertical',
        theme: 'dark',
        language: editorLanguage,
        usageStatistics: false,
        toolbarItems: [
          ['heading', 'bold', 'italic', 'strike'],
          ['hr', 'quote'],
          ['ul', 'ol', 'task', 'indent', 'outdent'],
          ['table', 'image', 'link'],
          ['code', 'codeblock'],
          ['scrollSync']
        ],
        initialValue: document.querySelector('#id_content').value || ''
      });

      // Initialize preview content editor (smaller)
      const previewEditor = new toastui.Editor({
        el: document.querySelector('#preview-editor'),
        height: '300px',
        initialEditType: 'markdown',
        previewStyle: 'vertical',
        theme: 'dark',
        language: editorLanguage,
        usageStatistics: false,
        toolbarItems: [
          ['heading', 'bold', 'italic'],
          ['ul', 'ol'],
          ['link'],
          ['code']
        ],
        initialValue: document.querySelector('#id_preview_content').value || ''
      });

      // Before form submission, sync editor content to hidden textareas
      const form = document.querySelector('form');
      form.addEventListener('submit', function(e) {
        document.querySelector('#id_content').value = contentEditor.getMarkdown();
        document.querySelector('#id_preview_content').value = previewEditor.getMarkdown();
      });
    })();
  </script>
{% endblock %}
